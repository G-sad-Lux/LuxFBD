<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lux | Sitio Sencillo y Responsivo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f8fafc;
            --card: #ffffff;
            --primary: #4c6ef5;
            --primary-dark: #364fc7;
            --text: #0f172a;
            --muted: #475569;
            --radius: 18px;
            --shadow: 0 12px 35px rgba(79, 70, 229, 0.08);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: 'Space Grotesk', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        img {
            max-width: 100%;
            display: block;
        }

        header {
            position: sticky;
            top: 0;
            background: #fff;
            z-index: 15;
            border-bottom: 1px solid rgba(15, 23, 42, 0.08);
            box-shadow: 0 12px 25px rgba(15, 23, 42, 0.04);
        }

        .app-header {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.85rem 1.5rem;
            gap: 1rem;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        .brand img {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            background: rgba(76, 110, 245, 0.1);
            padding: 0.3rem;
        }

        .brand-name {
            font-weight: 600;
            display: block;
        }

        .brand small {
            color: var(--muted);
            font-size: 0.8rem;
        }

        .nav-links {
            list-style: none;
            display: flex;
            gap: 1.2rem;
            margin: 0;
            padding: 0;
        }

        .nav-link {
            text-decoration: none;
            color: var(--muted);
            font-weight: 500;
            position: relative;
            padding: 0.35rem 0.2rem;
        }

        .nav-link.active,
        .nav-link:hover {
            color: var(--text);
        }

        .nav-link.active::after {
            content: "";
            position: absolute;
            left: 0;
            right: 0;
            bottom: -0.35rem;
            height: 3px;
            border-radius: 999px;
            background: var(--primary);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }

        .icon-button {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 1px solid rgba(15, 23, 42, 0.12);
            background: #fff;
            display: grid;
            place-items: center;
            cursor: pointer;
            color: var(--muted);
        }

        .profile-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.45rem;
            padding: 0.35rem 0.8rem;
            border-radius: 999px;
            border: 1px solid rgba(15, 23, 42, 0.12);
            font-weight: 600;
        }

        main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1.5rem 4rem;
            display: flex;
            flex-direction: column;
            gap: 3rem;
        }

        .hero {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            align-items: center;
        }

        .hero-card {
            background: var(--card);
            border-radius: var(--radius);
            padding: clamp(1.5rem, 4vw, 2.5rem);
            box-shadow: var(--shadow);
        }

        .hero-card small {
            display: inline-flex;
            padding: 0.35rem 0.8rem;
            border-radius: 999px;
            border: 1px solid rgba(76, 110, 245, 0.25);
            color: var(--primary-dark);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 600;
            font-size: 0.7rem;
        }

        .hero h1 {
            font-size: clamp(2rem, 6vw, 3.4rem);
            margin: 1rem 0 0.75rem;
            line-height: 1.15;
        }

        .hero p {
            color: var(--muted);
            margin-bottom: 1.5rem;
        }

        .hero-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .btn {
            border: none;
            border-radius: 999px;
            padding: 0.95rem 1.8rem;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: #fff;
            box-shadow: 0 12px 25px rgba(76, 110, 245, 0.3);
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid rgba(15, 23, 42, 0.18);
            color: var(--text);
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
        }

        .feature {
            background: var(--card);
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }

        .feature h3 {
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .feature p {
            color: var(--muted);
            font-size: 0.95rem;
        }

        .showcase {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.25rem;
        }

        .showcase figure {
            margin: 0;
            border-radius: var(--radius);
            overflow: hidden;
            background: #0f172a;
            color: #fff;
            position: relative;
            min-height: 220px;
            display: flex;
            align-items: flex-end;
            padding: 1.25rem;
        }

        .showcase span {
            font-weight: 600;
        }

        .contact {
            background: var(--card);
            border-radius: var(--radius);
            padding: clamp(1.5rem, 5vw, 2.5rem);
            box-shadow: var(--shadow);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 2rem;
        }

        .login-page {
            background: linear-gradient(135deg, rgba(76, 110, 245, 0.08), rgba(54, 79, 199, 0.05));
            border-radius: var(--radius);
            padding: clamp(2rem, 6vw, 3rem);
            display: flex;
            justify-content: center;
        }

        .login-card {
            width: min(480px, 100%);
            background: #fff;
            border-radius: 26px;
            padding: clamp(1.75rem, 4vw, 2.5rem);
            box-shadow: 0 25px 55px rgba(15, 23, 42, 0.12);
            border: 1px solid rgba(76, 110, 245, 0.12);
        }

        .login-card img {
            width: 120px;
            margin: 0 auto 1rem;
            display: block;
        }

        .login-card h2 {
            text-align: center;
            margin-bottom: 0.25rem;
        }

        .login-subtitle {
            text-align: center;
            color: var(--muted);
            margin-bottom: 1.5rem;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .login-form label {
            font-weight: 600;
            color: var(--muted);
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }

        .login-form input {
            border-radius: 10px;
        }

        .login-alert {
            border-radius: 12px;
            padding: 0.9rem 1rem;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .login-alert.error {
            background: rgba(244, 63, 94, 0.1);
            color: #b91c1c;
            border: 1px solid rgba(244, 63, 94, 0.3);
        }

        .login-alert.success {
            background: rgba(34, 197, 94, 0.12);
            color: #15803d;
            border: 1px solid rgba(34, 197, 94, 0.35);
        }

        .login-actions {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .login-links {
            margin-top: 1.25rem;
            border-top: 1px solid rgba(15, 23, 42, 0.08);
            padding-top: 1.25rem;
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
        }

        .login-links a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .login-guest {
            border-radius: 12px;
            padding: 0.85rem 1rem;
            background: rgba(15, 23, 42, 0.04);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .login-guest button {
            border-radius: 8px;
            padding: 0.5rem 1rem;
            border: none;
            background: var(--text);
            color: #fff;
            font-weight: 600;
            cursor: pointer;
        }

        .student-dashboard {
            display: flex;
            flex-direction: column;
            gap: 2rem;
            padding-top: 1rem;
        }

        .student-dashboard[hidden] {
            display: none;
        }

        .courses-layout {
            background: #fff;
            border-radius: 26px;
            padding: clamp(1.5rem, 4vw, 2.5rem);
            box-shadow: var(--shadow);
        }

        .courses-header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .eyebrow {
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-size: 0.75rem;
            color: var(--muted);
            margin: 0;
        }

        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 0.75rem;
            width: min(520px, 100%);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
            font-size: 0.85rem;
            color: var(--muted);
        }

        .filter-group select,
        .filter-group input {
            border-radius: 12px;
            border: 1px solid rgba(15, 23, 42, 0.18);
            padding: 0.65rem 0.85rem;
            font: inherit;
        }

        .course-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.2rem;
        }

        .course-card {
            border-radius: 18px;
            padding: 1rem;
            color: #fff;
            min-height: 150px;
            position: relative;
            overflow: hidden;
        }

        .course-card::after {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(0, 0, 0, 0.25));
            mix-blend-mode: soft-light;
            pointer-events: none;
        }

        .course-card>* {
            position: relative;
            z-index: 1;
        }

        .course-body {
            margin-bottom: 2rem;
        }

        .course-title {
            font-weight: 600;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        .course-format {
            font-size: 0.85rem;
            opacity: 0.85;
        }

        .course-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.9rem;
        }

        .course-progress {
            font-weight: 600;
        }

        .course-menu {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 34px;
            height: 34px;
            color: #fff;
            font-size: 1.1rem;
            cursor: pointer;
        }

        .courses-view {
            display: inline-flex;
            gap: 0.4rem;
            align-items: center;
        }

        .pill-button {
            border: 1px solid rgba(15, 23, 42, 0.2);
            background: transparent;
            color: var(--text);
            border-radius: 999px;
            padding: 0.35rem 0.9rem;
            font-weight: 600;
            cursor: pointer;
        }

        .pill-button.active {
            background: var(--text);
            color: #fff;
            border-color: var(--text);
        }

        .courses-footer {
            margin-top: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            color: var(--muted);
        }

        .courses-footer select {
            border-radius: 10px;
            border: 1px solid rgba(15, 23, 42, 0.18);
            padding: 0.4rem 0.8rem;
            font: inherit;
        }

        .hidden {
            display: none !important;
        }

        form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        input,
        textarea {
            border: 1px solid rgba(15, 23, 42, 0.15);
            border-radius: 12px;
            padding: 0.85rem 1rem;
            font: inherit;
            resize: vertical;
        }

        textarea {
            min-height: 140px;
        }

        footer {
            text-align: center;
            padding: 2rem 1rem 3rem;
            color: var(--muted);
            font-size: 0.9rem;
        }

        @media (max-width: 640px) {
            .app-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .nav-links {
                flex-wrap: wrap;
            }

            .hero-actions {
                flex-direction: column;
                width: 100%;
            }

            .btn {
                width: 100%;
                text-align: center;
            }

            .login-actions {
                flex-direction: column;
                align-items: stretch;
            }

            .login-guest {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }
        }

        /* Chatbot Widget */
        .chat-widget-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(76, 110, 245, 0.4);
            cursor: pointer;
            display: grid;
            place-items: center;
            font-size: 1.5rem;
            z-index: 1000;
            transition: transform 0.2s ease;
        }

        .chat-widget-btn:hover {
            transform: scale(1.05);
        }

        /* --- Support View Styles --- */
        .ticket-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            overflow: hidden;
        }

        .ticket-table th,
        .ticket-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .ticket-table th {
            background: rgba(0, 0, 0, 0.3);
            color: var(--gold);
            font-weight: 600;
        }

        .ticket-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-open {
            background: rgba(0, 255, 0, 0.1);
            color: #00ff00;
        }

        .status-closed {
            background: rgba(255, 255, 255, 0.1);
            color: #888;
        }

        /* Detail Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal.open {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background: #1a1a1a;
            border: 1px solid var(--gold);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 16px;
            padding: 30px;
            position: relative;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
            color: #efefef;
            /* Better default text color */
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .detail-item label {
            color: #aaa;
            /* Lighter grey for labels */
            font-size: 0.9em;
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .detail-item span {
            font-size: 1.1em;
            color: #fff;
            /* White for values */
            font-weight: 600;
        }

        .timeline {
            border-left: 2px solid var(--gold-dim);
            padding-left: 20px;
            margin-top: 20px;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 20px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -26px;
            top: 5px;
            width: 10px;
            height: 10px;
            background: var(--gold);
            border-radius: 50%;
        }

        .timeline-date {
            font-size: 0.8em;
            color: #888;
        }

        .timeline-content {
            background: rgba(255, 255, 255, 0.08);
            /* Slightly lighter background */
            padding: 15px;
            border-radius: 8px;
            margin-top: 5px;
            border: 1px solid #333;
            color: #ddd;
        }

        .timeline-content strong {
            color: var(--gold);
        }

        .chat-widget-btn[hidden] {
            display: none !important;
        }

        .chat-window {
            position: fixed;
            bottom: 6rem;
            right: 2rem;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            display: flex;
            flex-direction: column;
            z-index: 1000;
            overflow: hidden;
            transform-origin: bottom right;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            opacity: 0;
            transform: scale(0.9);
            pointer-events: none;
        }

        .chat-window.open {
            opacity: 1;
            transform: scale(1);
            pointer-events: all;
        }

        .chat-header {
            background: var(--primary);
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h3 {
            margin: 0;
            font-size: 1rem;
        }

        .chat-close {
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .chat-back {
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.2rem;
            margin-right: auto;
            /* Push others to right */
            display: none;
            /* Hidden by default */
        }

        .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            background: #f8fafc;
        }

        .message {
            max-width: 80%;
            padding: 0.8rem 1rem;
            border-radius: 12px;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .message.bot {
            background: white;
            border: 1px solid #e2e8f0;
            align-self: flex-start;
            border-bottom-left-radius: 2px;
        }

        .message.user {
            background: var(--primary);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 2px;
        }

        .chat-input-area {
            padding: 1rem;
            background: white;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 0.5rem;
        }

        .chat-input-area input {
            flex: 1;
            padding: 0.6rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .chat-send {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            width: 40px;
            cursor: pointer;
            display: grid;
            place-items: center;
        }

        .chat-attach-btn {
            background: transparent;
            color: var(--muted);
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            width: 40px;
            cursor: pointer;
            display: grid;
            place-items: center;
            font-size: 1.2rem;
        }

        .chat-attach-btn:hover {
            background: #f1f5f9;
            color: var(--primary);
        }

        .chat-options {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .chat-option-btn {
            background: white;
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 0.4rem 0.8rem;
            border-radius: 16px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chat-option-btn:hover {
            background: var(--primary);
            color: white;
        }
    </style>
</head>

<body>
    <header>
        <div class="app-header">
            <div class="brand">
                <img src="assets/images/lux-logo.svg" alt="Logo Universidad Lux" />
                <div>
                    <span class="brand-name">Universidad Lux</span>
                    <small>Campus Digital</small>
                </div>
            </div>
            <nav aria-label="Navegaci√≥n principal">
                <ul class="nav-links">
                    <li><a href="#login" class="nav-link" data-route="login">Inicio</a></li>
                    <li><a href="#mis-cursos" class="nav-link" data-route="tablero">Tablero</a></li>
                    <li><a href="#mis-cursos" class="nav-link" data-route="mis-cursos">Mis cursos</a></li>
                    <li><a href="#soporte" class="nav-link" data-route="soporte-luxia">Soporte LuxIA</a></li>

                </ul>
            </nav>
            <div class="header-actions">
                <button class="icon-button" aria-label="Notificaciones">üîî</button>
                <button class="icon-button" aria-label="Mensajes">‚úâÔ∏è</button>
                <div class="profile-chip">
                    <span>AT</span>
                    <small>Perfil</small>
                </div>
            </div>
        </div>
    </header>

    <main>
        <section id="login" class="login-page">
            <div class="login-card">
                <img src="assets/images/lux-logo.svg" alt="Logo Universidad Lux" />
                <h2>Ingreso a Campus Lux</h2>
                <p class="login-subtitle">Ingresa con tu correo institucional y contrase√±a.</p>
                <hr />
                <div id="login-alert" class="login-alert error" hidden>
                    Credenciales inv√°lidas. Intenta nuevamente.
                </div>
                <form id="login-form" class="login-form">
                    <label>
                        Correo Electr√≥nico
                        <input type="email" name="email" autocomplete="email" required placeholder="ejemplo@lux.edu">
                    </label>
                    <label>
                        Contrase√±a
                        <input type="password" name="password" autocomplete="current-password" required>
                    </label>
                    <div class="login-actions">
                        <button type="submit" class="btn btn-primary">Iniciar sesi√≥n</button>
                        <button type="button" class="btn btn-secondary">¬øOlvidaste tu contrase√±a?</button>
                    </div>
                </form>
                <div class="login-links">
                    <span>Algunos cursos permiten acceso invitado</span>
                    <div class="login-guest">
                        <div>
                            <strong>Visitante</strong>
                            <p style="margin: 0; color: var(--muted); font-size: 0.9rem;">Explora contenido limitado sin
                                credenciales.</p>
                        </div>
                        <button type="button">Entrar como invitado</button>
                    </div>
                    <a href="#">Aviso de cookies</a>
                </div>
            </div>
        </section>
        <div id="student-dashboard" class="student-dashboard" hidden>
            <section id="mis-cursos" class="courses-layout">
                <div class="courses-header">
                    <div>
                        <p class="eyebrow">Vista general del curso</p>
                        <h1>Mis cursos</h1>
                    </div>
                    <div class="courses-view">
                        <button type="button" class="pill-button active">Tarjeta</button>
                        <button type="button" class="pill-button">Lista</button>
                    </div>
                </div>

                <div class="filters">
                    <label class="filter-group">
                        <span>Categor√≠a</span>
                        <select>
                            <option>Todos</option>
                            <option>Virtual</option>
                            <option>Presencial</option>
                            <option>Licenciatura</option>
                        </select>
                    </label>
                    <label class="filter-group">
                        <span>Buscar</span>
                        <input type="search" placeholder="Nombre del curso" />
                    </label>
                    <label class="filter-group">
                        <span>Ordenar por</span>
                        <select>
                            <option>Nombre de curso</option>
                            <option>Fecha de inicio</option>
                            <option>Progreso</option>
                        </select>
                    </label>
                    <label class="filter-group">
                        <span>Vista</span>
                        <select>
                            <option>Tarjeta</option>
                            <option>Lista</option>
                        </select>
                    </label>
                </div>

                <div class="course-grid">
                    <article class="course-card" style="background: linear-gradient(135deg, #7c5bff, #5d34f3);">
                        <div class="course-body">
                            <p class="course-format">Virtual</p>
                            <p class="course-title">Competencias comunicativas (virtual) 2025-3</p>
                        </div>
                        <div class="course-footer">
                            <span class="course-progress">14% completado</span>
                            <button class="course-menu" aria-label="Opciones">‚ãÆ</button>
                        </div>
                    </article>
                    <article class="course-card" style="background: linear-gradient(135deg, #5d9ff3, #1877d2);">
                        <div class="course-body">
                            <p class="course-format">Virtual</p>
                            <p class="course-title">Desarrollo humano (virtual) 2025-3</p>
                        </div>
                        <div class="course-footer">
                            <span class="course-progress">Unidad 3</span>
                            <button class="course-menu" aria-label="Opciones">‚ãÆ</button>
                        </div>
                    </article>
                    <article class="course-card" style="background: linear-gradient(135deg, #1fa675, #0d7f57);">
                        <div class="course-body">
                            <p class="course-format">Licenciatura</p>
                            <p class="course-title">Estructura de datos (s√°b. 8:00 a 11:00)</p>
                        </div>
                        <div class="course-footer">
                            <span class="course-progress">Nuevo contenido</span>
                            <button class="course-menu" aria-label="Opciones">‚ãÆ</button>
                        </div>
                    </article>
                    <article class="course-card" style="background: linear-gradient(135deg, #7f6cf3, #8460d9);">
                        <div class="course-body">
                            <p class="course-format">Licenciatura</p>
                            <p class="course-title">Fundamentos de base de datos (sab.)</p>
                        </div>
                        <div class="course-footer">
                            <span class="course-progress">Semana 5</span>
                            <button class="course-menu" aria-label="Opciones">‚ãÆ</button>
                        </div>
                    </article>
                    <article class="course-card" style="background: linear-gradient(135deg, #2d9cca, #16658c);">
                        <div class="course-body">
                            <p class="course-format">Licenciatura</p>
                            <p class="course-title">Fundamentos de redes (sab. 4:00 pm)</p>
                        </div>
                        <div class="course-footer">
                            <span class="course-progress">Proyecto abierto</span>
                            <button class="course-menu" aria-label="Opciones">‚ãÆ</button>
                        </div>
                    </article>
                    <article class="course-card" style="background: linear-gradient(135deg, #5648c7, #40289b);">
                        <div class="course-body">
                            <p class="course-format">Licenciatura</p>
                            <p class="course-title">Integrales y aplicaciones (sab. horario)</p>
                        </div>
                        <div class="course-footer">
                            <span class="course-progress">Examen pronto</span>
                            <button class="course-menu" aria-label="Opciones">‚ãÆ</button>
                        </div>
                    </article>
                </div>

                <div class="courses-footer">
                    <span>Mostrar</span>
                    <select>
                        <option>Todos</option>
                        <option>5</option>
                        <option>10</option>
                    </select>
                </div>
            </section>

            <!-- Support View (Added) -->
            <section id="support-view" class="view-section" style="display:none; padding:80px 20px;">
                <div class="container mx-auto max-w-6xl">
                    <h2 class="text-3xl font-bold mb-6 text-white border-l-4 border-yellow-500 pl-4">Soporte LuxIA</h2>
                    <p class="text-white/60 mb-8 max-w-2xl">Consulta el estado de tus tickets y el historial de
                        atenci√≥n.</p>

                    <table class="ticket-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>T√≠tulo</th>
                                <th>Estado</th>
                                <th>Prioridad</th>
                                <th>Asignado</th>
                                <th>Fecha</th>
                            </tr>
                        </thead>
                        <tbody id="ticket-list-body">
                        </tbody>
                    </table>
                </div>

                <!-- Detail Modal -->
                <div id="ticket-detail-modal" class="modal">
                    <div class="modal-content">
                        <button onclick="closeTicketModal()"
                            style="position:absolute; top:15px; right:15px; background:none; border:none; color:white; font-size:1.5em; cursor:pointer;">&times;</button>
                        <div id="ticket-detail-content"></div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <footer>
        ¬© <span id="year"></span> Lux Studio. Todos los derechos reservados.
    </footer>

    <!-- Chatbot Widget -->
    <button id="chat-trigger" class="chat-widget-btn" aria-label="Abrir chat de soporte" hidden>
        üí¨
    </button>

    <div id="chat-window" class="chat-window">
        <div class="chat-header">
            <button id="chat-back" class="chat-back" aria-label="Atr√°s">‚¨Ö</button>
            <h3 style="margin-left: 0.5rem;">Lux-IA</h3>
            <button id="chat-close" class="chat-close" style="margin-left: auto;">√ó</button>
        </div>
        <div id="chat-messages" class="chat-messages">
            <!-- Messages will appear here -->
        </div>
        <div class="chat-input-area">
            <button id="chat-attach" class="chat-attach-btn" title="Adjuntar evidencia" disabled>üìé</button>
            <input type="file" id="chat-file" accept="image/*,.pdf" hidden>
            <input type="text" id="chat-input" placeholder="Escribe un mensaje..." disabled>
            <button id="chat-send" class="chat-send" disabled>‚û§</button>
        </div>
    </div>

    <!-- Image Viewer Modal (Lightbox) -->
    <div id="image-viewer-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:10000; align-items:center; justify-content:center; flex-direction:column;">
        <button onclick="closeImageViewer()"
            style="position:absolute; top:20px; right:30px; background:none; border:none; color:white; font-size:40px; cursor:pointer;">√ó</button>
        <img id="image-viewer-img" src=""
            style="max-width:90%; max-height:85%; border-radius:8px; box-shadow:0 0 20px rgba(0,0,0,0.5);">
        <p style="color:#aaa; margin-top:10px;">Clic fuera de la imagen para cerrar</p>
    </div>

    <!-- Supabase Integration -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script>
        document.getElementById('year').textContent = new Date().getFullYear();

        const loginForm = document.getElementById('login-form');
        const loginAlert = document.getElementById('login-alert');
        const loginSection = document.getElementById('login');
        const studentDashboard = document.getElementById('student-dashboard');
        const navLinks = document.querySelectorAll('.nav-link');

        // Initialize Supabase (Safe Mode)
        let supabase = null;
        try {
            if (window.supabaseConfig && window.supabase) {
                supabase = window.supabase.createClient(window.supabaseConfig.url, window.supabaseConfig.key);
                console.log('Supabase initialized successfully');
            } else {
                console.warn('Supabase config missing or library not loaded. Running in offline mode.');
            }
        } catch (err) {
            console.error('Critical error initializing Supabase:', err);
        }

        // --- Edge Function Integration: Catalog Service ---
        async function loadCatalogs() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                const token = session?.access_token;
                const projectRef = 'nsrduorngzyoiwpbkgku';
                const funcUrl = `https://${projectRef}.supabase.co/functions/v1/catalog-service`;

                const headers = token ? { 'Authorization': `Bearer ${token}` } : {};

                const resp = await fetch(funcUrl, { headers });
                if (!resp.ok) throw new Error('Failed to fetch catalogs');

                const data = await resp.json();
                console.log('Catalogs loaded via Edge Function:', data);

                // Populate Maps
                if (data.categorias) {
                    CATEGORY_MAP = {}; // Reset
                    data.categorias.forEach(c => {
                        const key = c.nombre.toLowerCase().replace(/\s+/g, '_').replace(/[^\w]/g, '');
                        CATEGORY_MAP[key] = c.catalogo_id;
                    });
                }
                if (data.prioridades) {
                    PRIORITY_MAP = {};
                    data.prioridades.forEach(p => {
                        const key = p.nombre.toLowerCase();
                        PRIORITY_MAP[key] = p.catalogo_id;
                    });
                }

                if (data.areas && data.areas.length > 0) {
                    const soporte = data.areas.find(a => a.nombre.toLowerCase().includes('soporte'));
                    if (soporte) {
                        DEFAULT_AREA_ID = soporte.catalogo_id;
                    } else {
                        DEFAULT_AREA_ID = data.areas[0].catalogo_id;
                    }
                }

            } catch (e) {
                console.warn('Catalog Service unavailable, using static fallbacks:', e);
                CATEGORY_MAP = STATIC_CATEGORY_MAP;
                PRIORITY_MAP = STATIC_PRIORITY_MAP;
            }
        }

        loadCatalogs();

        function setActiveNav(route) {
            navLinks.forEach((link) => {
                const isActive = link.dataset.route === route;
                link.classList.toggle('active', isActive);
            });
        }

        function showStudentView() {
            if (loginSection) loginSection.classList.add('hidden');
            if (studentDashboard) {
                studentDashboard.removeAttribute('hidden');
                studentDashboard.scrollIntoView({ behavior: 'smooth' });
            }
            if (chatTrigger) chatTrigger.removeAttribute('hidden');
            setActiveNav('mis-cursos');
        }

        function showAdminView() {
            if (loginSection) loginSection.classList.add('hidden');
            if (studentDashboard) {
                studentDashboard.removeAttribute('hidden');
                document.querySelectorAll('.view-section').forEach(el => el.style.display = 'none');
                document.getElementById('support-view').style.display = 'block';
                document.getElementById('mis-cursos').style.display = 'none';
            }
            if (chatTrigger) chatTrigger.setAttribute('hidden', '');

            setActiveNav('soporte-luxia');
            loadTickets(); // Load all tickets
        }

        if (loginForm) {
            loginForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const formData = new FormData(loginForm);
                const email = formData.get('email');
                const password = formData.get('password');

                try {
                    const { data, error } = await supabase.auth.signInWithPassword({
                        email: email,
                        password: password
                    });

                    if (error) throw error;

                    loginAlert.textContent = 'Acceso concedido.';
                    loginAlert.className = 'login-alert success';
                    loginAlert.hidden = false;

                    chatState.user = {
                        id: data.user.id,
                        email: data.user.email
                    };

                    const { data: profile } = await supabase
                        .from('usuario')
                        .select('tipo_usuario, nombre, apellido, usuario_id')
                        .eq('auth_uid', data.user.id)
                        .single();

                    chatState.user.role = profile ? profile.tipo_usuario : 'estudiante';
                    chatState.user.profileId = profile ? profile.usuario_id : null;
                    chatState.user.fullName = profile ? `${profile.nombre} ${profile.apellido}` : 'Usuario';

                    if (chatState.user.role === 'Administrativo' || chatState.user.role === 'Administrador' || chatState.user.role === 'Soporte') {
                        console.log('Admin login detected');
                        showAdminView();
                    } else {
                        showStudentView();
                    }

                    console.log('User Logged In:', data.user, profile);

                } catch (err) {
                    console.error('Login Error:', err.message);
                    loginAlert.textContent = 'Error: ' + (err.message === 'Invalid login credentials' ? 'Credenciales incorrectas.' : err.message);
                    loginAlert.className = 'login-alert error';
                    loginAlert.hidden = false;
                }
            });
        }

        // Chatbot Logic
        const chatTrigger = document.getElementById('chat-trigger');
        const chatWindow = document.getElementById('chat-window');
        const chatClose = document.getElementById('chat-close');
        const chatBack = document.getElementById('chat-back');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const chatSend = document.getElementById('chat-send');
        const chatAttach = document.getElementById('chat-attach');
        const chatFile = document.getElementById('chat-file');

        let chatState = {
            step: 'INIT',
            ticket: {},
            history: []
        };

        let CATEGORY_MAP = {};
        const STATIC_CATEGORY_MAP = {
            'finanzas': 33, 'sitio_web': 34, 'servo_web': 35, 'materias': 36, 'bloqueos': 37
        };

        let PRIORITY_MAP = {};
        const STATIC_PRIORITY_MAP = {
            'baja': 8, 'media': 7, 'alta': 6
        };

        let DEFAULT_AREA_ID = 38;
        const STEPS_FLOW = ['GREETING', 'TITLE', 'CATEGORY', 'DETAILS', 'ATTACHMENTS', 'PRIORITY', 'NOTIFY', 'DONE'];

        function toggleChat() {
            const isOpen = chatWindow.classList.contains('open');
            if (isOpen) {
                chatWindow.classList.remove('open');
            } else {
                chatWindow.classList.add('open');
                if (chatMessages.children.length === 0) {
                    initChat();
                }
            }
        }

        chatTrigger.addEventListener('click', toggleChat);
        chatClose.addEventListener('click', toggleChat);
        chatBack.addEventListener('click', goBack);

        function goBack() {
            const currentIdx = STEPS_FLOW.indexOf(chatState.step);
            if (currentIdx > 0) {
                const prevStep = STEPS_FLOW[currentIdx - 1];
                chatState.step = prevStep;
                showStepPrompt(prevStep);
            }
        }

        function updateUIForStep(step) {
            if (step === 'GREETING' || step === 'DONE') {
                chatBack.style.display = 'none';
            } else {
                chatBack.style.display = 'block';
            }
        }

        function addMessage(text, sender, options = []) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${sender}`;
            msgDiv.textContent = text;
            chatMessages.appendChild(msgDiv);

            if (options.length > 0) {
                const optionsDiv = document.createElement('div');
                optionsDiv.className = 'chat-options';
                options.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = 'chat-option-btn';
                    btn.textContent = opt.label;
                    btn.onclick = () => handleInput(opt.value);
                    optionsDiv.appendChild(btn);
                });
                chatMessages.appendChild(optionsDiv);
            }

            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function initChat() {
            chatState.step = 'GREETING';
            showStepPrompt('GREETING');
        }

        function showStepPrompt(step) {
            updateUIForStep(step);
            chatInput.value = '';

            switch (step) {
                case 'GREETING':
                    enableInput(false);
                    chatState.ticket = {};
                    addMessage('¬°Hola! Soy Lux-IA. ¬øEn qu√© puedo ayudarte hoy?', 'bot', [
                        { label: 'Reportar un problema', value: 'report' },
                        { label: 'Consultar estado de ticket', value: 'status' }
                    ]);
                    break;
                case 'TITLE':
                    enableInput(true);
                    addMessage('Entendido. Para comenzar, por favor escribe un t√≠tulo breve para tu incidencia.', 'bot');
                    break;
                case 'CATEGORY':
                    enableInput(false);
                    addMessage('Gracias. ¬øA qu√© categor√≠a pertenece el problema?', 'bot', [
                        { label: 'Finanzas', value: 'finanzas' },
                        { label: 'Sitio Web', value: 'sitio_web' },
                        { label: 'Servo Web', value: 'servo_web' },
                        { label: 'Materias', value: 'materias' },
                        { label: 'Bloqueos/Acceso', value: 'bloqueos' }
                    ]);
                    break;
                case 'DETAILS':
                    enableInput(true);
                    addMessage('Por favor describe los detalles del problema.', 'bot');
                    break;
                case 'ATTACHMENTS':
                    enableInput(false);
                    addMessage('¬øDeseas adjuntar alguna captura de pantalla o documento?', 'bot', [
                        { label: 'S√≠, adjuntar', value: 'attach_request' },
                        { label: 'No, continuar', value: 'no_attach' }
                    ]);
                    break;
                case 'PRIORITY':
                    enableInput(false);
                    addMessage('Archivo recibido (o omitido). ¬øQu√© nivel de prioridad consideras que tiene?', 'bot', [
                        { label: 'Baja', value: 'baja' },
                        { label: 'Media', value: 'media' },
                        { label: 'Alta', value: 'alta' }
                    ]);
                    break;
                case 'NOTIFY':
                    enableInput(false);
                    addMessage('¬øDeseas notificar a alg√∫n √°rea espec√≠fica? (Opcional)', 'bot', [
                        { label: 'Servicios Escolares', value: 'escolares' },
                        { label: 'Soporte T√©cnico', value: 'soporte' },
                        { label: 'Ninguno', value: 'none' }
                    ]);
                    break;
            }
        }

        function handleInput(text, isFile = false) {
            if (!text && !isFile) return;

            if (chatState.step === 'TITLE' && text.length < 5) {
                addMessage('El t√≠tulo es muy corto (m√≠nimo 5 letras).', 'bot');
                return;
            }
            if (chatState.step === 'DETAILS' && text.length < 15) {
                addMessage('Por favor danos m√°s detalles (m√≠nimo 15 letras).', 'bot');
                return;
            }

            if (isFile) {
                addMessage(`üìé Archivo adjunto: ${text}`, 'user');
            } else {
                addMessage(text, 'user');
                chatInput.value = '';
            }

            setTimeout(() => {
                const nextStep = getNextStep(chatState.step, text, isFile);
                if (nextStep) {
                    chatState.step = nextStep;
                    if (nextStep === 'DONE') {
                        finishTicket();
                    } else if (nextStep === 'ATTACH_ACTION') {
                        chatFile.click();
                        addMessage('Selecciona tu archivo...', 'bot');
                        chatState.step = 'ATTACHMENTS';
                    } else if (nextStep === 'STATUS_CHECK') {
                        addMessage('Esta funcionalidad estar√° disponible pronto.', 'bot');
                        resetChat();
                    } else {
                        showStepPrompt(nextStep);
                    }
                }
            }, 500);
        }

        function getNextStep(currentStep, input, isFile) {
            switch (currentStep) {
                case 'GREETING':
                    if (input === 'report') return 'TITLE';
                    if (input === 'status') return 'STATUS_CHECK';
                    return null;
                case 'TITLE':
                    chatState.ticket.title = input;
                    return 'CATEGORY';
                case 'CATEGORY':
                    chatState.ticket.category = input;
                    return 'DETAILS';
                case 'DETAILS':
                    chatState.ticket.details = input;
                    return 'ATTACHMENTS';
                case 'ATTACHMENTS':
                    if (input === 'attach_request') return 'ATTACH_ACTION';
                    if (input === 'no_attach') return 'PRIORITY';
                    if (isFile) {
                        chatState.ticket.evidence = input;
                        return 'PRIORITY';
                    }
                    return 'PRIORITY';
                case 'PRIORITY':
                    chatState.ticket.priority = input;
                    return 'NOTIFY';
                case 'NOTIFY':
                    chatState.ticket.notify = input === 'none' ? null : input;
                    return 'DONE';
                default:
                    return null;
            }
        }

        function enableInput(enable) {
            chatInput.disabled = !enable;
            chatSend.disabled = !enable;
            chatAttach.disabled = !enable;
            if (enable) chatInput.focus();
        }

        async function finishTicket() {
            addMessage('Procesando tu solicitud...', 'bot');
            updateUIForStep('DONE');

            try {
                if (!supabase) throw new Error('Supabase no configurado');

                const { data: { session } } = await supabase.auth.getSession();
                const token = session?.access_token;
                const projectRef = 'nsrduorngzyoiwpbkgku';
                const funcUrl = `https://${projectRef}.supabase.co/functions/v1/ticket-manager/create`;

                const load = {
                    titulo: chatState.ticket.title,
                    categoria_id: CATEGORY_MAP[chatState.ticket.category] || 37,
                    detalles: chatState.ticket.details,
                    prioridad_id: PRIORITY_MAP[chatState.ticket.priority] || 8,
                    area_notificada_id: DEFAULT_AREA_ID,
                    adjunto: chatState.ticket.attachment || null
                };

                const resp = await fetch(funcUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(load)
                });

                if (!resp.ok) {
                    const errData = await resp.json().catch(() => ({}));
                    throw new Error(errData.error || 'Error al crear ticket en servidor');
                }

                const data = await resp.json();
                const ticketId = data.ticket_id;

                addMessage(`‚úÖ ¬°Ticket creado con √©xito!`, 'bot');
                addMessage(`ID de seguimiento: #${ticketId}`, 'bot');
                addMessage(`Hemos notificado a soporte y recibir√°s una actualizaci√≥n pronto.`, 'bot');

            } catch (err) {
                console.error('Error creating ticket:', err);
                addMessage(`‚ùå Error al conectar.`, 'bot');
                addMessage(`Detalle: ${err.message}`, 'bot');
            }

            addMessage('¬øNecesitas algo m√°s?', 'bot', [
                { label: 'Crear otro ticket', value: 'report' },
                { label: 'Salir', value: 'exit' }
            ]);

            setTimeout(() => {
                chatState.step = 'GREETING';
            }, 1000);
        }

        function resetChat() {
            setTimeout(() => {
                initChat();
            }, 2000);
        }

        chatSend.addEventListener('click', () => handleInput(chatInput.value));
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleInput(chatInput.value);
        });

        chatAttach.addEventListener('click', () => chatFile.click());
        chatFile.addEventListener('change', async (e) => {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                addMessage(`Subiendo ${file.name}...`, 'bot');

                try {
                    if (!supabase) throw new Error('Supabase no disponible');

                    const userId = chatState.user ? chatState.user.id : 'anon';
                    const cleanName = file.name.replace(/[^\w.-]/g, '');
                    const filePath = `${userId}/${Date.now()}_${cleanName}`;

                    const { data, error } = await supabase.storage
                        .from('tickets')
                        .upload(filePath, file);

                    if (error) throw error;

                    const { data: { publicUrl } } = supabase.storage
                        .from('tickets')
                        .getPublicUrl(filePath);

                    chatState.ticket.attachment = {
                        nombre_archivo: file.name,
                        ruta_archivo_url: publicUrl,
                        size_bytes: file.size,
                        mime_type: file.type
                    };

                    handleInput(`üìé Archivo adjuntado: ${file.name}`, true);

                } catch (err) {
                    console.error('Upload error:', err);
                    addMessage('Error al subir archivo. Intenta de nuevo.', 'bot');
                }
            }
        });

        // Initial check
        if (chatTrigger) chatTrigger.setAttribute('hidden', '');
        setActiveNav('login');

        // --- Support Dashboard Logic ---
        function showSupportView() {
            // Hide other views
            document.querySelectorAll('section').forEach(el => el.style.display = 'none');
            const supportView = document.getElementById('support-view');
            if (supportView) supportView.style.display = 'block';

            // Hide specific main views
            const studentView = document.getElementById('student-view');
            if (studentView) studentView.style.display = 'none';
            const loginSection = document.getElementById('login');
            if (loginSection) loginSection.style.display = 'none';

            loadTickets();
        }

        async function loadTickets() {
            const tbody = document.getElementById('ticket-list-body');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center">Cargando tickets...</td></tr>';

            try {
                const { data: { session } } = await supabase.auth.getSession();
                const token = session?.access_token;
                const projectRef = 'nsrduorngzyoiwpbkgku';

                const resp = await fetch(`https://${projectRef}.supabase.co/functions/v1/ticket-manager/list`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!resp.ok) throw new Error('Error loading tickets');
                const tickets = await resp.json();

                tbody.innerHTML = '';
                if (tickets.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center">No hay tickets registrados.</td></tr>';
                    return;
                }

                tickets.forEach(t => {
                    const row = document.createElement('tr');
                    const date = new Date(t.fecha_creacion).toLocaleDateString();
                    // Optional safety check on related objects
                    const statusName = t.estado ? t.estado.nombre : 'Desconocido';
                    const prioName = t.prioridad ? t.prioridad.nombre : '-';
                    // Show "Pendiente" if not assigned
                    const assignedName = t.asignado ? `${t.asignado.nombre} ${t.asignado.apellido}` : 'Pendiente';
                    const statusClass = statusName === 'Abierto' ? 'status-open' : (statusName === 'Cerrado' ? 'status-closed' : 'status-badge');

                    row.innerHTML = `
                        <td>#${t.ticket_id}</td>
                        <td>${t.titulo}</td>
                        <td><span class="status-badge ${statusClass}">${statusName}</span></td>
                        <td>${prioName}</td>
                        <td>${assignedName}</td>
                        <td>${date}</td>
                    `;
                    row.onclick = () => openTicketDetail(t.ticket_id);
                    tbody.appendChild(row);
                });

            } catch (error) {
                console.error(error);
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:red">Error al cargar tickets (o faltan tablas relacionadas).</td></tr>';
            }
        }

        let STAFF_LIST = [];
        async function loadStaffList() {
            if (STAFF_LIST.length > 0) return;
            try {
                const { data: { session } } = await supabase.auth.getSession();
                const projectRef = 'nsrduorngzyoiwpbkgku';
                const resp = await fetch(`https://${projectRef}.supabase.co/functions/v1/ticket-manager/staff`, {
                    headers: { 'Authorization': `Bearer ${session?.access_token}` }
                });
                if (resp.ok) STAFF_LIST = await resp.json();
            } catch (e) { console.error('Failed to load staff list', e); }
        }

        async function openTicketDetail(ticketId) {
            const modal = document.getElementById('ticket-detail-modal');
            const content = document.getElementById('ticket-detail-content');
            content.innerHTML = '<p style="color:white;">Cargando detalles...</p>';
            modal.classList.add('open');

            // Load staff list in background only if admin/support
            if (chatState.user.role !== 'estudiante') {
                await loadStaffList();
            }

            try {
                const { data: { session } } = await supabase.auth.getSession();
                const projectRef = 'nsrduorngzyoiwpbkgku';
                const resp = await fetch(`https://${projectRef}.supabase.co/functions/v1/ticket-manager/details?id=${ticketId}`, {
                    headers: { 'Authorization': `Bearer ${session?.access_token}` }
                });

                if (!resp.ok) throw new Error('Error loading details');
                const data = await resp.json();
                const ticket = data.ticket;
                const history = data.history || [];
                const attachments = data.attachments || [];

                const statusName = ticket.estado ? ticket.estado.nombre : 'Unknown';
                const prioName = ticket.prioridad ? ticket.prioridad.nombre : 'Unknown';
                const areaName = ticket.area ? ticket.area.nombre : 'General';
                const reporterName = ticket.reportador ? `${ticket.reportador.nombre} ${ticket.reportador.apellido} (${ticket.reportador.tipo_usuario})` : 'Unknown';
                const assignedName = ticket.asignado ? `${ticket.asignado.nombre} ${ticket.asignado.apellido}` : 'Sin Asignar';

                // Build Actions
                let actionHTML = '';
                const canManage = ['Administrativo', 'Maestro', 'Soporte', 'Administrador'].includes(chatState.user.role);

                if (canManage) {
                    // Dropdown for Assignment
                    let staffOptions = '<option value="">-- Sin Asignar --</option>';
                    STAFF_LIST.forEach(s => {
                        const selected = (ticket.maestro_notificado_id === s.usuario_id) ? 'selected' : '';
                        staffOptions += `<option value="${s.usuario_id}" ${selected}>${s.nombre} ${s.apellido} (${s.tipo_usuario})</option>`;
                    });

                    actionHTML = `
                        <div style="margin-bottom: 20px; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px;">
                            <label style="color: var(--gold); display:block; margin-bottom:5px;">Asignar Ticket a:</label>
                            <div style="display:flex; gap:10px;">
                                <select id="assign-select" style="flex:1; padding:8px; border-radius:4px; border:1px solid #444; background:#222; color:white;">
                                    ${staffOptions}
                                </select>
                                <button onclick="assignTicketFromSelect(${ticket.ticket_id})" style="background:var(--primary); color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer;">Actualizar</button>
                            </div>
                        </div>
                    `;
                }

                // Render Attachments
                let attHTML = '';
                if (attachments.length > 0) {
                    attHTML = '<div class="detail-item" style="grid-column: 1 / -1; margin-top: 10px;"><label>Evidencias Adjuntas</label><div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:5px;">';
                    attachments.forEach(att => {
                        if (att.mime_type && att.mime_type.startsWith('image/')) {
                            // Use onclick to open lightbox instead of new tab
                            attHTML += `<div onclick="openImageViewer('${att.ruta_archivo_url}')" style="cursor:pointer; position:relative; group:hover;"><img src="${att.ruta_archivo_url}" style="width:100px; height:100px; object-fit:cover; border-radius:8px; border:1px solid #555; transition:transform 0.2s;"><div style="position:absolute; inset:0; background:rgba(0,0,0,0.3); display:flex; align-items:center; justify-content:center; opacity:0; hover:opacity:1; color:white; border-radius:8px;">üîç</div></div>`;
                        } else {
                            attHTML += `<a href="${att.ruta_archivo_url}" target="_blank" style="color: var(--gold); text-decoration: underline;">üìÑ ${att.nombre_archivo}</a>`;
                        }
                    });
                    attHTML += '</div></div>';
                }

                content.innerHTML = `
                    <h2 style="color:var(--gold); border-bottom:1px solid #333; padding-bottom:10px; margin-top:0;">
                        Ticket #${ticket.ticket_id}: ${ticket.titulo}
                    </h2>
                    
                    ${actionHTML}

                    <div class="detail-grid">
                        <div class="detail-item"><label>Estado</label><span>${statusName}</span></div>
                        <div class="detail-item"><label>Prioridad</label><span>${prioName}</span></div>
                        <div class="detail-item"><label>√Årea</label><span>${areaName}</span></div>
                        <div class="detail-item"><label>Estimado (ETA)</label><span>Pendiente</span></div>
                        <div class="detail-item"><label>Creado Por</label><span>${reporterName}</span></div>
                        <div class="detail-item"><label>Asignado A</label><span>${assignedName}</span></div>
                        
                        <div class="detail-item" style="grid-column: 1 / -1;">
                            <label>Detalles del Problema</label>
                            <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:8px; color:#ddd;">
                                ${ticket.detalles}
                            </div>
                        </div>
                        ${attHTML}
                    </div>

                    <h3 style="color:var(--primary);">Historial de Cambios</h3>
                    <div class="timeline">
                        ${history.map(h => `
                            <div class="timeline-item">
                                <div class="timeline-date">${new Date(h.fecha_cambio).toLocaleString()}</div>
                                <div class="timeline-content">
                                    <strong>${h.autor ? h.autor.nombre : 'Sistema'}:</strong> ${h.cambio || h.campo_modificado}
                                    ${h.valor_nuevo && h.valor_nuevo !== '-' ? `<br>‚ûî ${h.valor_nuevo}` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;

            } catch (err) {
                console.error(err);
                content.innerHTML = '<p style="color:red">Error al cargar detalles del ticket.</p>';
            }
        }

        function closeTicketModal() {
            document.getElementById('ticket-detail-modal').classList.remove('open');
        }

        async function assignTicketFromSelect(ticketId) {
            const select = document.getElementById('assign-select');
            const newAssigneeId = select.value;

            if (!newAssigneeId) {
                alert('Por favor selecciona un usuario.');
                return;
            }

            if (!confirm('¬øConfirmas reasignar este ticket?')) return;

            try {
                const { data: { session } } = await supabase.auth.getSession();
                const projectRef = 'nsrduorngzyoiwpbkgku';
                const funcUrl = `https://${projectRef}.supabase.co/functions/v1/ticket-manager/update`;

                const resp = await fetch(funcUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${session?.access_token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ticket_id: ticketId,
                        maestro_notificado_id: newAssigneeId
                    })
                });

                if (!resp.ok) throw new Error('Error al asignar');

                alert('‚úÖ Ticket actualizado.');
                openTicketDetail(ticketId);

            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        // Hook up navigation
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                const route = link.dataset.route;
                if (route === 'soporte-luxia') {
                    showSupportView();
                }
            });
        });

        // --- Image Viewer Logic ---
        function openImageViewer(url) {
            const modal = document.getElementById('image-viewer-modal');
            const img = document.getElementById('image-viewer-img');
            img.src = url;
            modal.style.display = 'flex';
        }

        function closeImageViewer() {
            const modal = document.getElementById('image-viewer-modal');
            modal.style.display = 'none';
            document.getElementById('image-viewer-img').src = '';
        }

        // Close on background click
        document.getElementById('image-viewer-modal').addEventListener('click', (e) => {
            if (e.target.id === 'image-viewer-modal') closeImageViewer();
        });
    </script>
</body>

</html>